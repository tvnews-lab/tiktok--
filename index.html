<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KBC TikTok æ¦‚è¦æ¬„è‡ªå‹•ç”Ÿæˆ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap"
    rel="stylesheet" />
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --surface2: #21262d;
      --border: rgba(240, 246, 252, 0.1);
      --accent: #fe2c55;
      --accent2: #69c9d0;
      --yt: #ff0000;
      --text: #c9d1d9;
      --white: #ffffff;
      --muted: #8b949e;
      --success: #238636;
      --radius: 12px;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      padding-bottom: 80px;
    }

    header {
      background: rgba(13, 17, 23, 0.8);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
    }

    h1 {
      font-size: 16px;
      font-weight: 900;
      color: var(--white);
    }

    main {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px 16px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 900;
      color: var(--white);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Video Card */
    .video-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 20px;
      display: flex;
      gap: 24px;
      transition: 0.2s;
    }

    .video-card:hover {
      border-color: rgba(254, 44, 85, 0.4);
    }

    .thumb-area {
      width: 220px;
      flex-shrink: 0;
    }

    .thumb-area img {
      width: 100%;
      border-radius: 8px;
      aspect-ratio: 16/9;
      object-fit: cover;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    .content-area {
      flex: 1;
      min-width: 0;
    }

    .v-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--white);
      margin-bottom: 12px;
      line-height: 1.5;
    }

    .tags-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .tag-badge {
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 6px;
      background: rgba(110, 118, 129, 0.2);
      border: 1px solid rgba(110, 118, 129, 0.4);
      color: var(--muted);
      font-weight: 500;
    }

    .tag-badge.region {
      background: rgba(105, 201, 208, 0.15);
      border-color: rgba(105, 201, 208, 0.5);
      color: var(--accent2);
    }

    .tag-badge.city {
      background: rgba(254, 44, 85, 0.15);
      border-color: rgba(254, 44, 85, 0.5);
      color: var(--accent);
    }

    .tag-badge.custom {
      background: rgba(251, 191, 36, 0.15);
      border-color: rgba(251, 191, 36, 0.5);
      color: #fbbf24;
    }

    .tag-badge.locked {
      background: var(--white);
      color: var(--bg);
      font-weight: 900;
      border: none;
    }

    .output-box {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      font-size: 14px;
    }

    .output-text {
      white-space: pre-wrap;
      word-break: break-all;
      margin-bottom: 16px;
      color: var(--white);
    }

    .btn {
      background: var(--surface2);
      color: var(--white);
      border: 1px solid var(--border);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      transition: 0.2s;
    }

    .btn:hover {
      background: #30363d;
      border-color: #8b949e;
    }

    .btn-primary {
      background: var(--accent);
      border-color: var(--accent);
    }

    .btn-primary:hover {
      background: #e62248;
      border-color: #e62248;
    }

    /* Custom Tags Drawer */
    .drawer-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 24px;
      margin-top: 40px;
    }

    .drawer-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--white);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .chip-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .chip {
      background: var(--surface2);
      border: 1px solid var(--border);
      padding: 4px 12px;
      border-radius: 99px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .chip button {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
    }

    .chip button:hover {
      color: var(--accent);
    }

    .input-row {
      display: flex;
      gap: 8px;
    }

    input[type="text"],
    input[type="password"] {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--white);
      padding: 10px 16px;
      flex: 1;
      font-size: 14px;
    }

    .loader-container {
      padding: 60px;
      text-align: center;
      color: var(--muted);
      border: 2px dashed var(--border);
      border-radius: var(--radius);
    }

    .spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(254, 44, 85, 0.1);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 16px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 650px) {
      .video-card {
        flex-direction: column;
        gap: 16px;
      }

      .thumb-area {
        width: 100%;
      }
    }
  </style>
</head>

<body>

  <header>
    <div class="brand">
      <div class="logo">ğŸµ</div>
      <h1>KBC TikTok æ¦‚è¦æ¬„è‡ªå‹•ç”Ÿæˆ</h1>
    </div>
    <button class="btn btn-primary" id="refreshBtn">æœ€æ–°10ä»¶ã‚’èª­ã¿è¾¼ã‚€</button>
  </header>

  <main>
    <div class="section-title">âœ¨ æœ€æ–°ãƒ‹ãƒ¥ãƒ¼ã‚¹æŠ•ç¨¿ãƒ†ã‚­ã‚¹ãƒˆ</div>

    <div id="videoListContainer">
      <div class="loader-container">
        <p>ä¸‹ã®ã€ŒYouTube APIè¨­å®šã€ã‚’å®Œäº†ã—ã¦ã€å³ä¸Šã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
      </div>
    </div>

    <!-- #è¿½åŠ æ¬„ (Custom Keywords) -->
    <div class="drawer-card">
      <div class="drawer-title">ğŸ·ï¸ #è¿½åŠ æ¬„ (ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¾æ›¸)</div>
      <div class="chip-container" id="customTagContainer">
        <!-- Chips will be inserted here -->
      </div>
      <div class="input-row">
        <input type="text" id="customTagInput" placeholder="è¿½åŠ ã—ãŸã„å˜èªï¼ˆä¾‹ï¼šã‚µãƒ³ã‚»ãƒƒãƒˆãƒ©ã‚¤ãƒ–ï¼‰" />
        <button class="btn" id="addCustomTagBtn">å€™è£œã«è¿½åŠ </button>
      </div>
      <p style="font-size: 12px; color: var(--muted); margin-top: 12px;">
        â€»ã“ã“ã«è¿½åŠ ã—ãŸå˜èªãŒè¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ãƒ»æ¦‚è¦æ¬„ã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€è‡ªå‹•ã§ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã¨ã—ã¦é¸ã°ã‚Œã¾ã™ã€‚
      </p>
    </div>

    <!-- API KEY Section (Moved to Bottom) -->
    <div class="drawer-card" style="margin-top: 20px; opacity: 0.8;">
      <div class="drawer-title">ğŸ”‘ YouTube APIè¨­å®š</div>
      <div class="input-row">
        <input type="password" id="apiKeyInput" placeholder="APIã‚­ãƒ¼ã‚’å…¥åŠ›" />
        <button class="btn" id="saveKeyBtn">è¨­å®šä¿å­˜</button>
      </div>
    </div>
  </main>

  <script>
    /* =====================================================
       å®šæ•°ãƒ»è¨­å®š
    ===================================================== */
    const CHANNEL_ID = 'UCS8ZQejq2CL-nZcnRWZCA5Q';
    const LOCKED_TAG = 'tiktokã§ãƒ‹ãƒ¥ãƒ¼ã‚¹';
    const SEPARATOR = 'â—†';
    const APIKEY_KEY = 'kbc_yt_apikey_v2';
    const CUSTOM_TAGS_KEY = 'kbc_custom_tags';

    /* --- åœ°åãƒªã‚¹ãƒˆ --- */
    const REGIONS = ['ç¦å²¡', 'ä½è³€'];
    const CITIES = [
      "ç¦å²¡å¸‚", "åŒ—ä¹å·å¸‚", "åšå¤š", "å¤©ç¥", "å°å€‰", "é–€å¸", "ä¹…ç•™ç±³å¸‚", "å¤§ç‰Ÿç”°å¸‚", "ç›´æ–¹å¸‚", "ç”°å·å¸‚", "æŸ³å·å¸‚", "å…«å¥³å¸‚", "ç­‘å¾Œå¸‚", "å¤§å·å¸‚", "è¡Œæ©‹å¸‚", "è±Šå‰å¸‚", "ä¸­é–“å¸‚", "å°éƒ¡å¸‚", "ç­‘ç´«é‡å¸‚", "æ˜¥æ—¥å¸‚", "å¤§é‡åŸå¸‚", "å®—åƒå¸‚", "å¤ªå®°åºœå¸‚", "å¤è³€å¸‚", "ç¦æ´¥å¸‚", "ã†ãã¯å¸‚", "å®®è‹¥å¸‚", "å˜‰éº»å¸‚", "æœå€‰å¸‚", "ã¿ã‚„ã¾å¸‚", "ç³¸å³¶å¸‚", "é‚£ç‚å·å¸‚",
      "ä½è³€å¸‚", "å”æ´¥å¸‚", "é³¥æ –å¸‚", "å¤šä¹…å¸‚", "ä¼Šä¸‡é‡Œå¸‚", "æ­¦é›„å¸‚", "é¹¿å³¶å¸‚", "å°åŸå¸‚", "å¬‰é‡å¸‚", "ç¥åŸ¼å¸‚"
    ];

    const CATEGORIES = [
      { tag: 'äº‹ä»¶', kw: ['é€®æ•', 'å®¹ç–‘è€…', 'æœæŸ»', 'è©æ¬º', 'çªƒç›—', 'å‚·å®³', 'æ®ºäºº', 'å¼·ç›—', 'æ‘˜ç™º', 'ç‰¹æ®Šè©æ¬º'] },
      { tag: 'äº‹æ•…', kw: ['äº‹æ•…', 'è¡çª', 'è¿½çª', 'æ­»äº¡', 'è² å‚·', 'ã‘ãŒ', 'ç‚ä¸Š', 'çˆ†ç™º'] },
      { tag: 'è¾²æ¥­', kw: ['è¾²æ¥­', 'è¾²å®¶', 'ç±³', 'é‡èœ', 'æœç‰©', 'åç©«', 'JA', 'ç”°æ¤ãˆ'] },
      { tag: 'å­è‚²ã¦', kw: ['å­è‚²ã¦', 'ä¿è‚²åœ’', 'å¹¼ç¨šåœ’', 'ã“ã©ã‚‚', 'è‚²ä¼‘', 'å‡ºç”£', 'å¦Šå¨ '] },
      { tag: 'æ•™è‚²', kw: ['å­¦æ ¡', 'æ•™è‚²', 'æˆæ¥­', 'å…¥è©¦', 'å—é¨“', 'å’æ¥­', 'å…¥å­¦'] },
      { tag: 'ç‰©ä¾¡é«˜', kw: ['ç‰©ä¾¡', 'å€¤ä¸ŠãŒã‚Š', 'å€¤ä¸Šã’', 'é«˜é¨°', 'ã‚¤ãƒ³ãƒ•ãƒ¬'] },
      { tag: 'ã‚¹ãƒãƒ¼ãƒ„', kw: ['ã‚¹ãƒãƒ¼ãƒ„', 'å„ªå‹', 'å¤§ä¼š', 'ä»£è¡¨', 'ãƒ›ãƒ¼ã‚¯ã‚¹', 'ã‚½ãƒ•ãƒˆãƒãƒ³ã‚¯', 'ã‚¢ãƒ“ã‚¹ãƒ‘', 'ã‚µã‚¬ãƒ³é³¥æ –'] },
      { tag: 'æ°—è±¡', kw: ['å¤§é›¨', 'è±ªé›¨', 'æµ¸æ°´', 'å°é¢¨', 'çŒ›æš‘', 'ç†±ä¸­ç—‡', 'åœ°éœ‡'] },
      { tag: 'ã‚°ãƒ«ãƒ¡', kw: ['ã‚°ãƒ«ãƒ¡', 'ãƒ©ãƒ³ãƒ', 'ãƒ©ãƒ¼ãƒ¡ãƒ³', 'ã‚«ãƒ•ã‚§', 'ã‚¹ã‚¤ãƒ¼ãƒ„'] },
      { tag: 'äº¤é€š', kw: ['æ¸‹æ»', 'æ–°å¹¹ç·š', 'è¸åˆ‡', 'ç©ºæ¸¯'] }
    ];

    /* =====================================================
       ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°é¸å®šãƒ­ã‚¸ãƒƒã‚¯ (Version 3)
    ===================================================== */
    function generateHashtags(title, desc) {
      const text = title + " " + desc;
      const selectedTags = [];
      const customTags = JSON.parse(localStorage.getItem(CUSTOM_TAGS_KEY) || "[]");

      // 1. åœ°åŸŸ (ç¦å²¡ãƒ»ä½è³€) - å¸‚ç”ºæ‘ãŒã‚ã£ã¦ã‚‚å¿…ãšå…¥ã‚Œã‚‹
      REGIONS.forEach(r => {
        if (text.includes(r)) {
          selectedTags.push({ name: r, type: 'region' });
        }
      });

      // 2. å¸‚åŒºç”ºæ‘ (1ã¤ã«åˆ¶é™)
      let foundCity = "";
      for (const city of CITIES) {
        if (text.includes(city)) {
          foundCity = city;
          break;
        }
      }
      if (foundCity) {
        // åœ°åŸŸã®åå‰ã¨é‡è¤‡ã—ãªã„å ´åˆã®ã¿è¿½åŠ 
        if (!selectedTags.find(t => t.name === foundCity.replace(/å¸‚$/, ''))) {
          selectedTags.push({ name: foundCity, type: 'city' });
        }
      }

      // 3. ã‚«ã‚¹ã‚¿ãƒ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¾æ›¸ (#è¿½åŠ æ¬„ ã‹ã‚‰ã®æ¤œç´¢)
      customTags.forEach(ct => {
        if (text.includes(ct)) {
          if (!selectedTags.find(t => t.name === ct)) {
            selectedTags.push({ name: ct, type: 'custom' });
          }
        }
      });

      // 4. å†…å®¹ã‚«ãƒ†ã‚´ãƒª (ã‚¹ã‚³ã‚¢é †)
      const catScores = CATEGORIES.map(cat => {
        let s = 0;
        cat.kw.forEach(k => { if (text.includes(k)) s++; });
        return { name: cat.tag, score: s };
      }).filter(c => c.score > 0).sort((a, b) => b.score - a.score);

      catScores.forEach(cs => {
        if (selectedTags.length < 5) { // å…¨ä½“ã§Lockedåˆã‚ã›ã¦6å€‹ç›®å®‰
          if (!selectedTags.find(t => t.name === cs.name)) {
            selectedTags.push({ name: cs.name, type: 'category' });
          }
        }
      });

      return selectedTags.slice(0, 5); // æ¬²å¼µã‚Šã™ããªã„ã‚ˆã†ã«
    }

    /* =====================================================
       UIãƒ»ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚°ç®¡ç†
    ===================================================== */
    function renderCustomTags() {
      const container = document.getElementById('customTagContainer');
      const tags = JSON.parse(localStorage.getItem(CUSTOM_TAGS_KEY) || "[]");
      container.innerHTML = '';
      tags.forEach((tag, idx) => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.innerHTML = `<span>${tag}</span><button onclick="removeCustomTag(${idx})">Ã—</button>`;
        container.appendChild(chip);
      });
    }

    function addCustomTag() {
      const input = document.getElementById('customTagInput');
      const word = input.value.trim();
      if (!word) return;
      const tags = JSON.parse(localStorage.getItem(CUSTOM_TAGS_KEY) || "[]");
      if (!tags.includes(word)) {
        tags.push(word);
        localStorage.setItem(CUSTOM_TAGS_KEY, JSON.stringify(tags));
        renderCustomTags();
      }
      input.value = '';
    }

    window.removeCustomTag = function (idx) {
      const tags = JSON.parse(localStorage.getItem(CUSTOM_TAGS_KEY) || "[]");
      tags.splice(idx, 1);
      localStorage.setItem(CUSTOM_TAGS_KEY, JSON.stringify(tags));
      renderCustomTags();
    };

    /* =====================================================
       ãƒ¡ã‚¤ãƒ³å‡¦ç†
    ===================================================== */
    window.addEventListener('DOMContentLoaded', () => {
      const savedKey = localStorage.getItem(APIKEY_KEY);
      if (savedKey) {
        document.getElementById('apiKeyInput').value = savedKey;
        fetchVideos();
      }
      renderCustomTags();

      document.getElementById('saveKeyBtn').addEventListener('click', () => {
        localStorage.setItem(APIKEY_KEY, document.getElementById('apiKeyInput').value.trim());
        alert('APIè¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚');
      });

      document.getElementById('addCustomTagBtn').addEventListener('click', addCustomTag);
      document.getElementById('refreshBtn').addEventListener('click', fetchVideos);
    });

    async function fetchVideos() {
      const apiKey = localStorage.getItem(APIKEY_KEY);
      if (!apiKey) return alert('APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');

      const container = document.getElementById('videoListContainer');
      container.innerHTML = '<div class="loader-container"><div class="spinner"></div><p>YouTubeã‹ã‚‰å‹•ç”»ã‚’å–å¾—ä¸­...</p></div>';

      try {
        const channelRes = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=contentDetails&id=${CHANNEL_ID}&key=${apiKey}`);
        const channelData = await channelRes.json();
        if (channelData.error) throw new Error(channelData.error.message);
        const uploadsId = channelData.items[0].contentDetails.relatedPlaylists.uploads;

        const playlistRes = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${uploadsId}&maxResults=10&key=${apiKey}`);
        const playlistData = await playlistRes.json();

        container.innerHTML = '';
        playlistData.items.forEach(item => renderVideo(item.snippet));

      } catch (err) {
        container.innerHTML = `<div class="loader-container" style="color:var(--accent)">ã‚¨ãƒ©ãƒ¼: ${err.message}</div>`;
      }
    }

    function renderVideo(snippet) {
      const title = snippet.title;
      if (title.includes('#shorts')) return;

      const desc = snippet.description || "";
      const firstSentence = (desc.split('ã€‚')[0] + (desc.includes('ã€‚') ? 'ã€‚' : '')).replace(/\r?\n/g, '');
      const cleanTitle = title.replace(/\r?\n/g, '');

      const autoTags = generateHashtags(title, desc);
      const tagString = "#" + LOCKED_TAG + " " + autoTags.map(t => "#" + t.name).join(' ');
      const combined = cleanTitle + SEPARATOR + firstSentence + " " + tagString;

      const card = document.createElement('div');
      card.className = 'video-card';
      card.innerHTML = `
    <div class="thumb-area"><img src="${snippet.thumbnails.medium.url}"></div>
    <div class="content-area">
      <div class="v-title">${cleanTitle}</div>
      <div class="tags-preview">
        <span class="tag-badge locked">#${LOCKED_TAG}</span>
        ${autoTags.map(t => `<span class="tag-badge ${t.type}">#${t.name}</span>`).join('')}
      </div>
      <div class="output-box">
        <div class="output-text" id="t-${snippet.resourceId.videoId}">${combined}</div>
        <button class="btn btn-primary" onclick="copyToClipboard(this, 't-${snippet.resourceId.videoId}')">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>
  `;
      document.getElementById('videoListContainer').appendChild(card);
    }

    window.copyToClipboard = function (btn, targetId) {
      const text = document.getElementById(targetId).innerText;
      navigator.clipboard.writeText(text).then(() => {
        const original = btn.innerText;
        btn.innerText = 'âœ… ã‚³ãƒ”ãƒ¼å®Œäº†';
        btn.style.background = '#238636';
        setTimeout(() => {
          btn.innerText = original;
          btn.style.background = '#fe2c55';
        }, 2000);
      });
    };
  </script>
</body>

</html>